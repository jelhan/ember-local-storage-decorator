{"version":3,"file":"manager.js","sources":["../../src/storage/manager.ts"],"sourcesContent":["import type {\n  DecoratorPropertyDescriptor,\n  ElementDescriptor,\n} from '@ember/-internals/metal';\nimport { TrackedMap } from 'tracked-built-ins';\n\n// like JSON.parse() but all returned objects are frozen\nfunction jsonParseAndFreeze(json: string | null | undefined): unknown {\n  if (!json) {\n    return undefined;\n  }\n\n  const parsed: unknown = JSON.parse(\n    json,\n    (_key: string, value: unknown): unknown =>\n      typeof value === 'object' && value !== null\n        ? Object.freeze(value)\n        : value,\n  );\n\n  return parsed;\n}\n\n// This will detect if the function arguments match the legacy decorator pattern\nfunction isElementDescriptor(...args: unknown[]): boolean {\n  const [maybeTarget, maybeKey, maybeDescriptor] = args;\n\n  return (\n    (args.length === 2 || args.length === 3) &&\n    (typeof maybeTarget === 'function' ||\n      (typeof maybeTarget === 'object' && maybeTarget !== null)) &&\n    typeof maybeKey === 'string' &&\n    ((typeof maybeDescriptor === 'object' &&\n      maybeDescriptor !== null &&\n      'enumerable' in maybeDescriptor &&\n      'configurable' in maybeDescriptor) ||\n      maybeDescriptor === undefined)\n  );\n}\n\nexport type StorageManager = {\n  decoratorFactory: (...args: unknown[]) => unknown;\n  clearCache: () => void;\n  initializeKey: (key: string) => void;\n};\n\nexport function createStorageManager(storage: Storage): StorageManager {\n  const managedKeys = new Set<string>();\n  const cache = new TrackedMap<string, unknown>(new Map());\n\n  // register event listener to update local state on storage changes\n  // StorageEvent is only fired for changes to localStorage across documents,\n  // but it's safe to register the listener for both storage types and\n  // ignore irrelevant events.\n  window.addEventListener(\n    'storage',\n    function ({ key, newValue, storageArea }: StorageEvent) {\n      if (!key) {\n        return;\n      }\n\n      // skip changes to other keys\n      if (!managedKeys.has(key)) {\n        return;\n      }\n\n      // ensure this event is for the storage area we manage\n      // storageArea can be null in test environments, so we allow it through\n      if (storageArea !== null && storageArea !== storage) {\n        return;\n      }\n\n      // skip if setting to same value\n      if (cache.get(key) === newValue) {\n        return;\n      }\n\n      cache.set(key, jsonParseAndFreeze(newValue));\n    },\n  );\n\n  function initializeKey(key: string) {\n    if (!managedKeys.has(key)) {\n      managedKeys.add(key);\n      cache.set(key, jsonParseAndFreeze(storage.getItem(key)));\n    }\n  }\n\n  function clearCache() {\n    managedKeys.clear();\n    cache.clear();\n  }\n\n  function decoratorFactory(...args: unknown[]): unknown {\n    const isDirectDecoratorInvocation = isElementDescriptor(...args);\n    const customKey: string | undefined = isDirectDecoratorInvocation\n      ? undefined\n      : (args[0] as string | undefined);\n\n    function storageDecorator(\n      target: object,\n      key: string,\n      descriptor?: DecoratorPropertyDescriptor,\n    ): DecoratorPropertyDescriptor {\n      const storageKey = customKey ?? key;\n\n      initializeKey(storageKey);\n\n      return {\n        enumerable: true,\n        configurable: true,\n        get() {\n          const cachedValue = cache.get(storageKey);\n          if (cachedValue !== undefined) {\n            return cachedValue;\n          }\n\n          if (descriptor?.initializer) {\n            return (descriptor.initializer as () => unknown).call(target);\n          }\n\n          return undefined;\n        },\n        set(value: unknown) {\n          const json = JSON.stringify(value);\n\n          // Update cache with a frozen copy of the value\n          cache.set(storageKey, jsonParseAndFreeze(json));\n\n          // Update the actual storage area\n          storage.setItem(storageKey, json);\n        },\n      };\n    }\n\n    return isDirectDecoratorInvocation\n      ? storageDecorator(...(args as ElementDescriptor))\n      : storageDecorator;\n  }\n\n  return {\n    decoratorFactory,\n    clearCache,\n    initializeKey,\n  };\n}\n"],"names":["jsonParseAndFreeze","json","undefined","parsed","JSON","parse","_key","value","Object","freeze","isElementDescriptor","args","maybeTarget","maybeKey","maybeDescriptor","length","createStorageManager","storage","managedKeys","Set","cache","TrackedMap","Map","window","addEventListener","key","newValue","storageArea","has","get","set","initializeKey","add","getItem","clearCache","clear","decoratorFactory","isDirectDecoratorInvocation","customKey","storageDecorator","target","descriptor","storageKey","enumerable","configurable","cachedValue","initializer","call","stringify","setItem"],"mappings":"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"}